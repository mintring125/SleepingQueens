<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sleeping Queens - 참가</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#6D28D9">
  <link rel="icon" href="/icons/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="stylesheet" href="/shared/styles/common.css">
  <link rel="stylesheet" href="/player/player.css">
  <style>
    .name-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin: 16px 0;
    }
    .name-btn {
      padding: 16px 28px;
      font-size: 18px;
      font-weight: 700;
      border-radius: 50px;
      border: 3px solid transparent;
      background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);
      color: var(--primary);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .name-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
    }
    .name-btn.selected {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .name-btn.add-btn {
      background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
      color: var(--secondary-dark);
      font-size: 24px;
      padding: 16px 24px;
    }
    .custom-name-input {
      display: none;
      margin-top: 12px;
    }
    .custom-name-input.show {
      display: block;
    }
    .custom-name-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .custom-name-row input {
      flex: 1;
    }
    .custom-name-row button {
      padding: 12px 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sleeping Queens</h1>
      <p>게임에 참가하세요</p>
    </div>

    <div class="panel join-panel">
      <div id="scanSection">
        <h2>QR 코드 스캔</h2>
        <div id="qrReader" class="qr-reader"></div>
        <button class="primary" id="scanBtn" onclick="toggleScanner()">카메라로 스캔</button>
        <div class="divider"><span>또는</span></div>
      </div>

      <div id="manualSection">
        <h2>세션 코드 입력</h2>
        <input type="text" id="sessionInput" placeholder="세션 코드" class="input-field">
      </div>

      <div class="name-section">
        <h2>이름 선택</h2>
        <div class="name-buttons" id="nameButtons">
          <button type="button" class="name-btn" data-name="김형석" onclick="selectName('김형석', this)">김형석</button>
          <button type="button" class="name-btn" data-name="김나은" onclick="selectName('김나은', this)">김나은</button>
          <button type="button" class="name-btn" data-name="김아림" onclick="selectName('김아림', this)">김아림</button>
          <button type="button" class="name-btn add-btn" onclick="showCustomInput()">+</button>
        </div>
        <div id="customNameInput" class="custom-name-input">
          <div class="custom-name-row">
            <input type="text" id="customName" placeholder="새 이름 입력" class="input-field" maxlength="10">
            <button class="primary" onclick="addCustomName()">추가</button>
          </div>
        </div>
      </div>

      <input type="hidden" id="nameInput" value="">

      <button class="success join-btn" id="joinBtn" onclick="joinGame()">참가하기</button>
      <p id="joinMessage" class="join-message"></p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
  <script src="/shared/env.js"></script>
  <script src="/shared/socket.js"></script>
  <script>
    let scanner = null;
    let selectedName = '';

    document.addEventListener('DOMContentLoaded', () => {
      socketManager.connect();

      // Check URL params for session ID
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session');
      if (sessionId) {
        document.getElementById('sessionInput').value = sessionId;
      }

      socketManager.on('joinResult', (data) => {
        if (data.success) {
          // Store player info and redirect to game
          localStorage.setItem('playerId', data.playerId);
          localStorage.setItem('playerName', data.playerName);
          localStorage.setItem('sessionId', data.sessionId);
          window.location.href = '/player/index.html?session=' + data.sessionId;
        } else {
          showJoinMessage(data.message, 'error');
        }
      });
    });

    function selectName(name, btn) {
      // Deselect all buttons
      document.querySelectorAll('.name-btn').forEach(b => b.classList.remove('selected'));
      // Select this one
      btn.classList.add('selected');
      selectedName = name;
      document.getElementById('nameInput').value = name;
      // Hide custom input if open
      document.getElementById('customNameInput').classList.remove('show');
    }

    function showCustomInput() {
      document.getElementById('customNameInput').classList.toggle('show');
      document.getElementById('customName').focus();
    }

    function addCustomName() {
      const name = document.getElementById('customName').value.trim();
      if (!name) {
        showJoinMessage('이름을 입력하세요', 'error');
        return;
      }
      if (name.length > 10) {
        showJoinMessage('이름은 10자 이하로 입력하세요', 'error');
        return;
      }

      // Add new button
      const container = document.getElementById('nameButtons');
      const addBtn = container.querySelector('.add-btn');
      
      const newBtn = document.createElement('button');
      newBtn.type = 'button';
      newBtn.className = 'name-btn selected';
      newBtn.dataset.name = name;
      newBtn.textContent = name;
      newBtn.onclick = function() { selectName(name, this); };
      
      container.insertBefore(newBtn, addBtn);
      
      // Deselect others, select this
      document.querySelectorAll('.name-btn').forEach(b => b.classList.remove('selected'));
      newBtn.classList.add('selected');
      
      selectedName = name;
      document.getElementById('nameInput').value = name;
      document.getElementById('customName').value = '';
      document.getElementById('customNameInput').classList.remove('show');
      showJoinMessage(`'${name}' 추가됨!`, 'success');
    }

    function toggleScanner() {
      const readerDiv = document.getElementById('qrReader');
      const btn = document.getElementById('scanBtn');

      if (scanner) {
        scanner.stop().then(() => {
          scanner = null;
          readerDiv.innerHTML = '';
          btn.textContent = '카메라로 스캔';
        });
        return;
      }

      if (typeof Html5Qrcode !== 'undefined') {
        scanner = new Html5Qrcode('qrReader');
        scanner.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: { width: 200, height: 200 } },
          (decodedText) => {
            // Parse URL to get session ID
            try {
              const url = new URL(decodedText);
              const sessionId = url.searchParams.get('session');
              if (sessionId) {
                document.getElementById('sessionInput').value = sessionId;
                scanner.stop();
                scanner = null;
                readerDiv.innerHTML = '';
                btn.textContent = '카메라로 스캔';
                showJoinMessage('세션 코드가 입력되었습니다!', 'success');
              }
            } catch (e) {
              document.getElementById('sessionInput').value = decodedText;
            }
          }
        ).then(() => {
          btn.textContent = '스캔 중지';
        }).catch(err => {
          showJoinMessage('카메라를 사용할 수 없습니다: ' + err, 'error');
        });
      } else {
        showJoinMessage('QR 스캐너를 로드할 수 없습니다', 'error');
      }
    }

    function joinGame() {
      const sessionId = document.getElementById('sessionInput').value.trim();
      const name = selectedName || document.getElementById('nameInput').value.trim();

      if (!sessionId) {
        showJoinMessage('세션 코드를 입력하세요', 'error');
        return;
      }
      if (!name) {
        showJoinMessage('이름을 선택하세요', 'error');
        return;
      }
      if (name.length > 10) {
        showJoinMessage('이름은 10자 이하로 입력하세요', 'error');
        return;
      }

      socketManager.emit('joinGame', { sessionId, playerName: name });
    }

    function showJoinMessage(text, type) {
      const el = document.getElementById('joinMessage');
      el.textContent = text;
      el.className = 'join-message ' + type;
    }
  </script>
</body>
</html>
